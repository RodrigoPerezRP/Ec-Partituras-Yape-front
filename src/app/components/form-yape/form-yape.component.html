<div
  class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-6 font-poppins"
>
  <div class="w-full max-w-3xl bg-white rounded-2xl shadow-md p-8 relative">
    <button
      type="button"
      (click)="closeModalYape()"
      class="cursor-pointer absolute top-7 right-7 w-8 h-8 flex items-center justify-center text-purple-500 hover:text-purple-700 rounded-full transition"
      aria-label="Cerrar modal"
    >
      <svg
        class="w-10 h-10"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="3"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>

    <form class="gap-8" [formGroup]="formYape" (ngSubmit)="handleSubmit()">
      <!-- COLUMNA IZQUIERDA -->
      <div>
        <h2 class="text-2xl text-center font-bold text-purple-700 mb-6">
          Paga Con Yape
        </h2>

        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-x-4 gap-y-6">
            <!-- Número de teléfono -->
            <div>
              <label class="block text-sm font-semibold text-purple-600 mb-1">
                Número de teléfono
              </label>
              <input
                type="tel"
                maxlength="9"
                formControlName="phoneNumber"
                placeholder="Ej: 900000000"
                [class.border-red-500]="
                  formYape.get('phoneNumber')?.invalid &&
                  formYape.get('phoneNumber')?.touched
                "
                class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
              />
              <!-- Mensajes de error -->
              <div class="mt-1 text-xs text-red-600 min-h-[20px]">
                @if (formYape.get('phoneNumber')?.touched) { @if
                (formYape.get('phoneNumber')?.hasError('required')) {
                <span>El número de teléfono es requerido</span>
                } @if (formYape.get('phoneNumber')?.hasError('pattern') ||
                formYape.get('phoneNumber')?.hasError('minlength') ||
                formYape.get('phoneNumber')?.hasError('maxlength')) {
                <span>Debe ser un número de 9 dígitos (ej: 900000000)</span>
                } }
              </div>
            </div>

            <!-- Código OTP -->
            <div>
              <label class="block text-sm font-semibold text-purple-600 mb-1">
                Código de aprobación
              </label>
              <input
                type="text"
                formControlName="otp"
                placeholder="Ej: 845921"
                maxlength="6"
                [class.border-red-500]="
                  formYape.get('otp')?.invalid && formYape.get('otp')?.touched
                "
                class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
              />
              <!-- Mensajes de error -->
              <div class="mt-1 text-xs text-red-600 min-h-[20px]">
                @if (formYape.get('otp')?.touched) { @if
                (formYape.get('otp')?.hasError('required')) {
                <span>El código OTP es requerido</span>
                } @if (formYape.get('otp')?.hasError('pattern') ||
                formYape.get('otp')?.hasError('minlength') ||
                formYape.get('otp')?.hasError('maxlength')) {
                <span>Debe tener exactamente 6 dígitos</span>
                } }
              </div>
            </div>

            <!-- Número de WhatsApp -->
            <div>
              <label class="block text-sm font-semibold text-purple-600 mb-1">
                Número de WhatsApp
              </label>
              <input
                type="tel"
                formControlName="whatsappNumber"
                maxlength="9"
                placeholder="Ej: 900000000"
                [class.border-red-500]="
                  formYape.get('whatsappNumber')?.invalid &&
                  formYape.get('whatsappNumber')?.touched
                "
                class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
              />
              <!-- Mensajes de error -->
              <div class="mt-1 text-xs text-red-600 min-h-[20px]">
                @if (formYape.get('whatsappNumber')?.touched) { @if
                (formYape.get('whatsappNumber')?.hasError('required')) {
                <span>El número de WhatsApp es requerido</span>
                } @if (formYape.get('whatsappNumber')?.hasError('pattern') ||
                formYape.get('whatsappNumber')?.hasError('minlength') ||
                formYape.get('whatsappNumber')?.hasError('maxlength')) {
                <span>Debe ser un número de 9 dígitos (ej: 900000000)</span>
                } }
              </div>
            </div>

            <!-- Correo electrónico -->
            <div>
              <label class="block text-sm font-semibold text-purple-600 mb-1">
                Correo electrónico
              </label>
              <input
                type="email"
                formControlName="email"
                placeholder="ejemplo@correo.com"
                [class.border-red-500]="
                  formYape.get('email')?.invalid &&
                  formYape.get('email')?.touched
                "
                class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
              />
              <!-- Mensajes de error -->
              <div class="mt-1 text-xs text-red-600 min-h-[20px]">
                @if (formYape.get('email')?.touched) { @if
                (formYape.get('email')?.hasError('required')) {
                <span>El correo electrónico es requerido</span>
                } @if (formYape.get('email')?.hasError('email')) {
                <span>Ingrese un correo electrónico válido</span>
                } }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- COLUMNA DERECHA -->
      <div class="rounded-2xl mt-4">
        <div class="grid grid-cols-2 gap-4 mb-8">
          <div class="rounded-xl">
            <img
              [src]="env.API_URL_IMAGE + partitura.portada"
              alt="Producto"
              class="w-36 h-36 object-cover"
            />
          </div>

          <div class="text-right">
            <h3 class="text-md font-semibold text-gray-800">
              {{ partitura.nombre }}
            </h3>
            <p class="text-sm text-gray-500 mt-1">
              {{ partitura.categoria?.nombre }}
            </p>
            <p class="text-sm text-gray-500 mt-1">
              {{ partitura.arreglista }}
            </p>
            @if (partitura.tieneAudio){
            <p class="text-sm text-gray-500 mt-1">Contiene Audio</p>
            } @if (partitura.tieneFinale){
            <p class="text-sm text-gray-500 mt-1">Contiene Archivo Finale</p>
            }
          </div>
        </div>

        <div class="border-t border-gray-200 pt-4 space-y-3 text-md">
          <div class="flex justify-between font-semibold">
            <span>Total</span>
            <span>S/{{ partitura.precio }}</span>
          </div>
        </div>

        <button
          type="submit"
          [disabled]="formYape.invalid || isSubmitting"
          [class.opacity-50]="formYape.invalid"
          [class.cursor-not-allowed]="formYape.invalid"
          class="w-full mt-6 py-3 rounded-xl bg-purple-400 text-white font-semibold hover:bg-purple-500 transition disabled:bg-gray-300"
        >
          @if (isSubmitting) { Procesando pago... } @else if (formYape.invalid)
          { Complete los datos } @else { Pagar }
        </button>

        <div class="pt-3 text-center">
          <p class="text-gray-800 text-md font-bold">
            Los Archivos se enviaran a su Whatsapp y su Email
          </p>
        </div>
      </div>
    </form>
  </div>
</div>

<div *ngIf="showModalSuccess()">
  <app-success-modal />
</div>

<div *ngIf="showModalFailed()">
  <app-failed-modal />
</div>

@if (isSubmitting && !showModalSuccess() && !showModalFailed()) {
  <app-loader-pay />
}